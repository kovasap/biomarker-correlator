{"version":3,"sources":["app/stats.cljs"],"mappings":"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","names":["app.stats/p-value-cutoff","app.stats/compute-linear-estimate","model","input","params","kixi.stats.protocols/parameters","offset","cljs.core/first","slope","cljs.core/last","app.stats/calc-rsq","linear-model","var1","var2","data","cljs.core.transduce","cljs.core/identity","p1__49003#","kixi.stats.core/r-squared","var_args","args__4870__auto__","len__4864__auto__","i__4865__auto__","argseq__4871__auto__","cljs.core/IndexedSeq","app.stats/filter-missing","seq49006","G__49007","cljs.core/next","self__4851__auto__","ks","cljs.core.filter","datum","p1__49005#","cljs.core/every?","cljs.core/not","js/isNaN","app.stats/PairedData","app.stats/clean-data","p1__49035#","cljs.core.map","cljs.core/select-keys","app.stats.filter_missing","app.stats/get-correlation-with-pval","r","kixi.stats.core/correlation","degrees-of-freedom","cljs.core/count","t-stat","kixi.stats.math/sqrt","kixi.stats.math/sq","t-test","kixi.stats.test.test_result","kixi.stats.distribution/t","p-val","kixi.stats.test/p-value","app.stats/get-plot-scale","variable","var-data","cljs.core.apply","cljs.core/min","cljs.core/max","app.stats/CorrelationResults","app.specs/ReagentComponent","app.time/Timestamp","app.stats/CorrelationResultsLite","app.stats/calc-correlation","cleaned-data","correlation-result","oz.core/vega-lite","app.math/round","rounded-pval","cljs.core._EQ_","app.stats/PairwiseCorrelations","app.stats/PairwiseCorrelationsLite","app.stats/enliten","pairwise-correlations","p1__49060#","cljs.core.update_in","cljs.core/dissoc","app.stats/compute-correlations","inputs","biomarkers","iter__4652__auto__","s__49064","cljs.core/LazySeq","temp__5753__auto__","cljs.core/seq","xs__6308__auto__","iterys__4648__auto__","s__49066","cljs.core/chunked-seq?","c__4650__auto__","size__4651__auto__","b__49068","cljs.core/chunk-buffer","i__49067","cljs.core/-nth","cljs.core/chunk-append","cljs.core/chunk-cons","cljs.core/chunk","iter__49065","cljs.core/chunk-rest","cljs.core/cons","cljs.core/rest","fs__4649__auto__","cljs.core.concat","iter__49063","biomarker","cljs.core/chunk-first"],"sourcesContent":["(ns app.stats\n  (:require\n    [app.specs :as specs]\n    [app.csv-data-processing :as proc]\n    [app.time :as time]\n    [app.math :as math]\n    [oz.core :as oz]\n    [kixi.stats.math :refer [sq sqrt]]\n    [kixi.stats.core :as kixi]\n    [kixi.stats.test :as kixi-t]\n    [kixi.stats.distribution :as kixi-d]\n    [kixi.stats.protocols :as kixi-p]))\n\n(def p-value-cutoff 0.05)\n\n; model is [offset slope]\n(defn compute-linear-estimate [model input]\n  (let [params (kixi-p/parameters model)\n        offset (first params)\n        slope (last params)]\n    (+ offset (* slope input))))\n\n(defn calc-rsq\n  \"To compute r-squared, we need to compare each value in data for var2\n  to the value we would expected to get for var2 if we plugged var1\n  into our linear model (computed by kixi/simple-linear-regression)\n  To do this, we need to pass in to kixi/r-squared: \n    1. a function that takes in a data entry, plugs var1 into the linear\n       model, and returns the var2 value according to the model\n    2. a function that takes in a data entry and returns the actual\n       var2 value\"\n  [linear-model var1 var2 data]\n  (if (nil? linear-model)\n    nil\n    (transduce\n     identity (kixi/r-squared\n               #(compute-linear-estimate linear-model (var1 %))\n               var2)\n     data)))\n\n(defn filter-missing\n  \"Remove maps from data (collection of maps) for which any of the given keys\n  are not present or have nil values.\"\n  [data & ks]\n  (filter (fn [datum] (every? #(not (js/isNaN (% datum))) ks))\n          data))\n\n; TODO make sure this only has 2 values when (+ the timestamp)\n; https://github.com/metosin/malli/issues/652 is resolved\n(def PairedData [:sequential [:map-of :keyword [:or :int :double]]])\n\n(defn clean-data\n  {:malli/schema [:=> [:cat :keyword :keyword [:sequential proc/ProcessedRow]]\n                  PairedData]}\n  [var1 var2 data]\n  (map #(select-keys % [:timestamp var1 var2])\n        (filter-missing data var1 var2)))\n\n\n(defn get-correlation-with-pval\n  \"Gets a correlation between the two given vars in the data.\n  \n  See discussion at https://github.com/MastodonC/kixi.stats/issues/40 for some\n  more context\"\n  [data var1 var2]\n  (let [r (transduce identity (kixi/correlation var1 var2) data)\n        degrees-of-freedom (- (count data) 2)\n        t-stat (/ (* r (sqrt degrees-of-freedom))\n                  (sqrt (- 1 (sq r))))\n        t-test (kixi-t/test-result t-stat (kixi-d/t {:v degrees-of-freedom}))\n        p-val (kixi-t/p-value t-test)]\n    {:correlation r\n     :p-value p-val}))\n\n(defn get-plot-scale\n  [variable data]\n  (let [var-data (map variable data)]\n    {:domain [(apply min var-data)\n              (apply max var-data)]}))\n\n(def CorrelationResults\n  [:map [:scatterplot specs/ReagentComponent]\n        [:correlation :double]\n        [:p-value :double]\n        [:raw-data [:sequential [:map [:timestamp time/Timestamp]]]]\n        [:datapoints :int]])\n\n(def CorrelationResultsLite\n  [:map [:correlation :double]\n        [:p-value :double]\n        [:datapoints :int]])\n\n(defn calc-correlation\n  {:malli/schema [:=> [:cat :keyword :keyword [:sequential proc/ProcessedRow]]\n                  CorrelationResults]}\n  [var1 var2 data]\n  (let [cleaned-data (clean-data var1 var2 data)\n        ; linear-result (transduce identity\n        ;                          (kixi/simple-linear-regression var1 var2)\n        ;                          cleaned-data))\n        ; rsq (calc-rsq linear-result var1 var2 cleaned-data)\n        correlation-result (get-correlation-with-pval cleaned-data var1 var2)]\n        ; error (transduce identity\n        ;                  (kixi/regression-standard-error var1 var2)\n        ;                  cleaned-data]\n    ; (if (and (= var1 :na) (= var2 :hdl))\n    ;   (do (prn cleaned-data) (prn correlation-result))\n    ; {:linear-slope (round (if (nil? linear-result) nil\n    ;                           (last (kixi-p/parameters linear-result)))]\n    ;  :linear-r-squared (round rsq)\n    {:scatterplot [oz.core/vega-lite\n                   {:data {:values cleaned-data}\n                    :width 300\n                    :height 300\n                    :mark \"circle\"\n                    :encoding {:x {:field var1\n                                   :scale (get-plot-scale var1 data)\n                                   :type \"quantitative\"}\n                               :y {:field var2\n                                   :scale (get-plot-scale var2 data)\n                                   :type \"quantitative\"}\n                               :color {:field :timestamp \n                                       :scale {:type \"time\"\n                                               :scheme \"viridis\"}}}}]\n     :raw-data cleaned-data\n     :correlation (math/round (:correlation correlation-result))\n     :p-value (:p-value correlation-result)\n     :rounded-p-value (let [rounded-pval\n                            (math/round (:p-value correlation-result))]\n                        (if (= 0 rounded-pval) \"<0.001\" (str rounded-pval)))\n     :datapoints (count cleaned-data)}))\n\n(def PairwiseCorrelations\n  [:sequential\n   [:map [:input :keyword]\n         [:biomarker :keyword]\n         [:regression-results CorrelationResults]]])\n\n(def PairwiseCorrelationsLite\n  [:sequential\n   [:map [:input :keyword]\n         [:biomarker :keyword]\n         [:regression-results CorrelationResultsLite]]])\n\n(defn enliten\n  {:malli/schema [:=> [:cat PairwiseCorrelations]\n                  PairwiseCorrelationsLite]}\n  [pairwise-correlations]\n  (map #(update-in % [:regression-results] dissoc :scatterplot :raw-data)\n       pairwise-correlations))\n\n(defn compute-correlations\n  {:malli/schema [:=> [:cat\n                       [:sequential :keyword]\n                       [:sequential :keyword]\n                       [:sequential proc/ProcessedRow]]\n                  PairwiseCorrelations]}\n  [inputs biomarkers data]\n  (for [input inputs\n        biomarker biomarkers]\n    {:input input\n     :biomarker biomarker\n     :regression-results (calc-correlation input biomarker data)}))\n"]}