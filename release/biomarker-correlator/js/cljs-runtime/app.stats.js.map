{"version":3,"sources":["app/stats.cljs"],"mappings":"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","names":["app.stats/p-value-cutoff","app.stats/compute-linear-estimate","model","input","params","kixi.stats.protocols/parameters","offset","cljs.core/first","slope","cljs.core/last","app.stats/calc-rsq","linear-model","var1","var2","data","cljs.core.transduce","cljs.core/identity","p1__82841#","kixi.stats.core/r-squared","var_args","args__4870__auto__","len__4864__auto__","i__4865__auto__","argseq__4871__auto__","cljs.core/IndexedSeq","app.stats/filter-missing","seq82873","G__82874","cljs.core/next","self__4851__auto__","ks","cljs.core.filter","datum","p1__82867#","cljs.core/every?","cljs.core/not","js/isNaN","app.stats/make-into-floats","cljs.core.into","iter__4652__auto__","s__82891","cljs.core/LazySeq","temp__5753__auto__","cljs.core/seq","cljs.core/chunked-seq?","c__4650__auto__","size__4651__auto__","cljs.core/count","b__82893","cljs.core/chunk-buffer","i__82892","vec__82895","cljs.core/-nth","cljs.core.nth","cljs.core/chunk-append","cljs.core/chunk-cons","cljs.core/chunk","iter__82890","cljs.core/chunk-rest","vec__82901","cljs.core/cons","cljs.core/rest","k","v","fexpr__82899","fexpr__82905","js/parseFloat","app.stats/round","n","Math/round","js/Number","app.stats/get-correlation-with-pval","r","kixi.stats.core/correlation","degrees-of-freedom","t-stat","kixi.stats.math/sqrt","kixi.stats.math/sq","t-test","kixi.stats.test.test_result","kixi.stats.distribution/t","p-val","kixi.stats.test/p-value","app.stats/get-plot-scale","variable","var-data","cljs.core.map","cljs.core.apply","cljs.core/min","cljs.core/max","app.stats/CorrelationResults","app.specs/ReagentComponent","app.time/Timestamp","app.stats/CorrelationResultsLite","app.stats/calc-correlation","cleaned-data","p1__82914#","cljs.core/select-keys","app.stats.filter_missing","correlation-result","oz.core/vega-lite","rounded-pval","cljs.core._EQ_","app.stats/PairwiseCorrelations","app.stats/PairwiseCorrelationsLite","app.stats/enliten","pairwise-correlations","p1__82923#","cljs.core.update_in","cljs.core/dissoc","app.stats/compute-correlations","inputs","biomarkers","s__82926","xs__6308__auto__","iterys__4648__auto__","s__82928","b__82930","i__82929","iter__82927","fs__4649__auto__","cljs.core.concat","iter__82925","biomarker","cljs.core/chunk-first"],"sourcesContent":["(ns app.stats\n  (:require\n    [app.specs :as specs]\n    [app.csv-data-processing :as proc]\n    [app.time :as time]\n    [oz.core :as oz]\n    [kixi.stats.math :refer [sq sqrt]]\n    [kixi.stats.core :as kixi]\n    [kixi.stats.test :as kixi-t]\n    [kixi.stats.distribution :as kixi-d]\n    [kixi.stats.protocols :as kixi-p]))\n\n(def p-value-cutoff 0.05)\n\n; model is [offset slope]\n(defn compute-linear-estimate [model input]\n  (let [params (kixi-p/parameters model)\n        offset (first params)\n        slope (last params)]\n    (+ offset (* slope input))))\n\n(defn calc-rsq\n  \"To compute r-squared, we need to compare each value in data for var2\n  to the value we would expected to get for var2 if we plugged var1\n  into our linear model (computed by kixi/simple-linear-regression)\n  To do this, we need to pass in to kixi/r-squared: \n    1. a function that takes in a data entry, plugs var1 into the linear\n       model, and returns the var2 value according to the model\n    2. a function that takes in a data entry and returns the actual\n       var2 value\"\n  [linear-model var1 var2 data]\n  (if (nil? linear-model)\n    nil\n    (transduce\n     identity (kixi/r-squared\n               #(compute-linear-estimate linear-model (var1 %))\n               var2)\n     data)))\n\n(defn filter-missing\n  \"Remove maps from data (collection of maps) for which any of the given keys\n  are not present or have nil values.\"\n  [data & ks]\n  (filter (fn [datum] (every? #(not (js/isNaN (% datum))) ks))\n          data))\n\n(defn make-into-floats\n  {:malli/schema [:=> [:cat\n                       [:map-of :keyword :any]]\n                  [:map-of :keyword :double]]}\n  [data]\n  (into {} (for [[k v] data]\n             [k (if (#{:date :timestamp} k)\n                  v\n                  (js/parseFloat v))])))\n\n(defn round [n]\n  (/ (Math/round (* 1000 (+ n (. js/Number -EPSILON)))) 1000))\n\n(defn get-correlation-with-pval\n  \"Gets a correlation between the two given vars in the data.\n  \n  See discussion at https://github.com/MastodonC/kixi.stats/issues/40 for some\n  more context\"\n  [data var1 var2]\n  (let [r (transduce identity (kixi/correlation var1 var2) data)\n        degrees-of-freedom (- (count data) 2)\n        t-stat (/ (* r (sqrt degrees-of-freedom))\n                  (sqrt (- 1 (sq r))))\n        t-test (kixi-t/test-result t-stat (kixi-d/t {:v degrees-of-freedom}))\n        p-val (kixi-t/p-value t-test)]\n    {:correlation r\n     :p-value p-val}))\n\n(defn get-plot-scale\n  [variable data]\n  (let [var-data (map variable data)]\n    {:domain [(apply min var-data)\n              (apply max var-data)]}))\n\n(def CorrelationResults\n  [:map [:scatterplot specs/ReagentComponent]\n        [:correlation :double]\n        [:p-value :double]\n        [:raw-data [:sequential [:map [:timestamp time/Timestamp]]]]\n        [:datapoints :int]])\n\n(def CorrelationResultsLite\n  [:map [:correlation :double]\n        [:p-value :double]\n        [:datapoints :int]])\n\n(defn calc-correlation\n  [var1 var2 data]\n  ; [keyword? keyword? :app.specs/maps\n  ;  => ::regression-results]\n  (let [cleaned-data (map #(select-keys % [:timestamp var1 var2])\n                          (filter-missing\n                            data ; (map make-into-floats data)\n                            var1 var2))\n        ; linear-result (transduce identity\n        ;                          (kixi/simple-linear-regression var1 var2)\n        ;                          cleaned-data))\n        ; rsq (calc-rsq linear-result var1 var2 cleaned-data)\n        correlation-result (get-correlation-with-pval cleaned-data var1 var2)]\n        ; error (transduce identity\n        ;                  (kixi/regression-standard-error var1 var2)\n        ;                  cleaned-data]\n    ; (prn (first  cleaned-data))\n    ; (if (and (= var1 :na) (= var2 :hdl))\n    ;   (do (prn cleaned-data) (prn correlation-result))\n    ; {:linear-slope (round (if (nil? linear-result) nil\n    ;                           (last (kixi-p/parameters linear-result)))]\n    ;  :linear-r-squared (round rsq)\n    {:scatterplot [oz.core/vega-lite\n                   {:data {:values cleaned-data}\n                    :width 300\n                    :height 300\n                    :mark \"circle\"\n                    :encoding {:x {:field var1\n                                   :scale (get-plot-scale var1 data)\n                                   :type \"quantitative\"}\n                               :y {:field var2\n                                   :scale (get-plot-scale var2 data)\n                                   :type \"quantitative\"}\n                               :color {:field :timestamp \n                                       :scale {:type \"time\"\n                                               :scheme \"viridis\"}}}}]\n     :raw-data cleaned-data\n     :correlation (round (:correlation correlation-result))\n     :p-value (:p-value correlation-result)\n     :rounded-p-value (let [rounded-pval (round (:p-value correlation-result))]\n                        (if (= 0 rounded-pval) \"<0.001\" (str rounded-pval)))\n     :datapoints (count cleaned-data)}))\n\n(def PairwiseCorrelations\n  [:sequential\n   [:map [:input :keyword]\n         [:biomarker :keyword]\n         [:regression-results CorrelationResults]]])\n\n(def PairwiseCorrelationsLite\n  [:sequential\n   [:map [:input :keyword]\n         [:biomarker :keyword]\n         [:regression-results CorrelationResultsLite]]])\n\n(defn enliten\n  {:malli/schema [:=> [:cat PairwiseCorrelations]\n                  PairwiseCorrelationsLite]}\n  [pairwise-correlations]\n  (map #(update-in % [:regression-results] dissoc :scatterplot :raw-data)\n       pairwise-correlations))\n\n(defn compute-correlations\n  {:malli/schema [:=> [:cat\n                       [:sequential :keyword]\n                       [:sequential :keyword]\n                       [:sequential proc/ProcessedRow]]\n                  PairwiseCorrelations]}\n  [inputs biomarkers data]\n  (for [input inputs\n        biomarker biomarkers]\n    {:input input\n     :biomarker biomarker\n     :regression-results (calc-correlation input biomarker data)}))\n"]}