{"version":3,"sources":["app/stats.cljs"],"mappings":"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","names":["app.stats/p-value-cutoff","app.stats/compute-linear-estimate","model","input","params","kixi.stats.protocols/parameters","offset","cljs.core/first","slope","cljs.core/last","app.stats/calc-rsq","linear-model","var1","var2","data","cljs.core.transduce","cljs.core/identity","p1__58892#","kixi.stats.core/r-squared","var_args","args__4870__auto__","len__4864__auto__","i__4865__auto__","argseq__4871__auto__","cljs.core/IndexedSeq","app.stats/filter-missing","seq58894","G__58895","cljs.core/next","self__4851__auto__","ks","cljs.core.filter","datum","p1__58893#","cljs.core/every?","cljs.core/not","js/isNaN","app.stats/make-into-floats","cljs.core.into","iter__4652__auto__","s__58897","cljs.core/LazySeq","temp__5753__auto__","cljs.core/seq","cljs.core/chunked-seq?","c__4650__auto__","size__4651__auto__","cljs.core/count","b__58899","cljs.core/chunk-buffer","i__58898","vec__58900","cljs.core/-nth","cljs.core.nth","cljs.core/chunk-append","cljs.core/chunk-cons","cljs.core/chunk","iter__58896","cljs.core/chunk-rest","vec__58903","cljs.core/cons","cljs.core/rest","k","v","cljs.core._EQ_","js/parseFloat","app.stats/round","n","Math/round","js/Number","app.stats/get-correlation-with-pval","r","kixi.stats.core/correlation","degrees-of-freedom","t-stat","kixi.stats.math/sqrt","kixi.stats.math/sq","t-test","kixi.stats.test.test_result","kixi.stats.distribution/t","p-val","kixi.stats.test/p-value","app.stats/get-plot-scale","variable","var-data","cljs.core.map","cljs.core.apply","cljs.core/min","cljs.core/max","app.stats/regression-results","spec_tools.data_spec.spec","cljs.core/float?","cljs.core/int?","cljs.spec.alpha/def-impl","app.stats/CorrelationResults","app.specs/Hiccup","app.time/Timestamp","app.stats/calc-correlation","cleaned-data","p1__58910#","cljs.core/select-keys","app.stats.filter_missing","correlation-result","oz.core/vega-lite","rounded-pval","app.stats/PairwiseCorrelations","app.stats/compute-correlations","inputs","biomarkers","s__58919","xs__6308__auto__","iterys__4648__auto__","s__58921","b__58923","i__58922","iter__58920","fs__4649__auto__","cljs.core.concat","iter__58918","biomarker","cljs.core/chunk-first"],"sourcesContent":["(ns app.stats\n  (:require\n    [app.specs :as specs]\n    [app.csv-data-processing :as proc]\n    [app.time :as time]\n    [oz.core :as oz]\n    [malli.core :as m]\n    [ghostwheel.core :as g :refer [>defn >defn- >fdef => | <- ?]]\n    [spec-tools.data-spec :as ds]\n    [cljs.spec.alpha :as s]\n    [kixi.stats.math :refer [sq sqrt]]\n    [kixi.stats.core :as kixi]\n    [kixi.stats.test :as kixi-t]\n    [kixi.stats.distribution :as kixi-d]\n    [kixi.stats.protocols :as kixi-p]))\n\n(def p-value-cutoff 0.05)\n\n; model is [offset slope]\n(defn compute-linear-estimate [model input]\n  (let [params (kixi-p/parameters model)\n        offset (first params)\n        slope (last params)]\n    (+ offset (* slope input))))\n\n(defn calc-rsq\n  \"To compute r-squared, we need to compare each value in data for var2\n  to the value we would expected to get for var2 if we plugged var1\n  into our linear model (computed by kixi/simple-linear-regression)\n  To do this, we need to pass in to kixi/r-squared: \n    1. a function that takes in a data entry, plugs var1 into the linear\n       model, and returns the var2 value according to the model\n    2. a function that takes in a data entry and returns the actual\n       var2 value\"\n  [linear-model var1 var2 data]\n  (if (nil? linear-model)\n    nil\n    (transduce\n     identity (kixi/r-squared\n               #(compute-linear-estimate linear-model (var1 %))\n               var2)\n     data)))\n\n(defn filter-missing\n  \"Remove maps from data (collection of maps) for which any of the given keys\n  are not present or have nil values.\"\n  [data & ks]\n  (filter (fn [datum] (every? #(not (js/isNaN (% datum))) ks))\n          data))\n\n(defn make-into-floats\n  {:malli/schema [:=> [:cat\n                       [:map-of [:keyword :string]]]\n                  [:map-of [:keyword :number]]]}\n  [data]\n  (into {} (for [[k v] data]\n             [k (if (= k :timestamp)\n                  v\n                  (js/parseFloat v))])))\n\n(defn round [n]\n  (/ (Math/round (* 1000 (+ n (. js/Number -EPSILON)))) 1000))\n\n(defn get-correlation-with-pval\n  \"Gets a correlation between the two given vars in the data.\n  \n  See discussion at https://github.com/MastodonC/kixi.stats/issues/40 for some\n  more context\"\n  [data var1 var2]\n  (let [r (transduce identity (kixi/correlation var1 var2) data)\n        degrees-of-freedom (- (count data) 2)\n        t-stat (/ (* r (sqrt degrees-of-freedom))\n                  (sqrt (- 1 (sq r))))\n        t-test (kixi-t/test-result t-stat (kixi-d/t {:v degrees-of-freedom}))\n        p-val (kixi-t/p-value t-test)]\n    {:correlation r\n     :p-value p-val}))\n\n(defn get-plot-scale\n  [variable data]\n  (let [var-data (map variable data)]\n    {:domain [(apply min var-data)\n              (apply max var-data)]}))\n\n(def regression-results\n  (ds/spec ::regression-results\n    {:scatterplot :app.specs/hiccup\n     :correlation float?\n     :p-value float?\n     :raw-data :app.csv-data-processing/processed-rows\n     :datapoints int?}))\n(s/def ::regression-results regression-results)\n\n(def CorrelationResults\n  [:map [:scatterplot specs/Hiccup]\n        [:correlation :number]\n        [:p-value :number]\n        [:raw-data [:sequential [:map [:timestamp time/Timestamp]]]]\n        [:datapoints :int]])\n\n(defn calc-correlation\n  [var1 var2 data]\n  ; [keyword? keyword? :app.specs/maps\n  ;  => ::regression-results]\n  (let [cleaned-data (map #(select-keys % [:timestamp var1 var2])\n                          (filter-missing\n                            (map make-into-floats data)\n                            var1 var2))\n        ; linear-result (transduce identity\n        ;                          (kixi/simple-linear-regression var1 var2)\n        ;                          cleaned-data))\n        ; rsq (calc-rsq linear-result var1 var2 cleaned-data)\n        correlation-result (get-correlation-with-pval cleaned-data var1 var2)]\n        ; error (transduce identity\n        ;                  (kixi/regression-standard-error var1 var2)\n        ;                  cleaned-data]\n    ; (prn (first  cleaned-data))\n    ; (if (and (= var1 :na) (= var2 :hdl))\n    ;   (do (prn cleaned-data) (prn correlation-result))\n    ; {:linear-slope (round (if (nil? linear-result) nil\n    ;                           (last (kixi-p/parameters linear-result)))]\n    ;  :linear-r-squared (round rsq)\n    {:scatterplot [oz.core/vega-lite\n                   {:data {:values cleaned-data}\n                    :width 300\n                    :height 300\n                    :mark \"circle\"\n                    :encoding {:x {:field var1\n                                   :scale (get-plot-scale var1 data)\n                                   :type \"quantitative\"}\n                               :y {:field var2\n                                   :scale (get-plot-scale var2 data)\n                                   :type \"quantitative\"}\n                               :color {:field :timestamp \n                                       :scale {:type \"time\"\n                                               :scheme \"viridis\"}}}}]\n     :raw-data cleaned-data\n     :correlation (round (:correlation correlation-result))\n     :p-value (:p-value correlation-result)\n     :rounded-p-value (let [rounded-pval (round (:p-value correlation-result))]\n                        (if (= 0 rounded-pval) \"<0.001\" (str rounded-pval)))\n     :datapoints (count cleaned-data)}))\n\n(def PairwiseCorrelations\n  [:sequential\n   [:map [:input :keyword]\n         [:biomarker :keyword]\n         [:regression-results CorrelationResults]]])\n\n(defn compute-correlations\n  {:malli/schema [:=> [:cat\n                       [:sequential :keyword]\n                       [:sequential :keyword]\n                       proc/ProcessedRows]\n                  PairwiseCorrelations]}\n  [inputs biomarkers data]\n  ; [(s/coll-of keyword?) (s/coll-of keyword?)\n  ;  :app.csv-data-processing/processed-rows\n  ;  => ::pairwise-correlations]\n  (for [input inputs\n        biomarker biomarkers]\n    {:input input\n     :biomarker biomarker\n     :regression-results (calc-correlation input biomarker data)}))\n"]}