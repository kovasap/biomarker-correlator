{"version":3,"sources":["app/csv_data_processing.cljs"],"mappings":"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","names":["cljs.spec.alpha/def-impl","cljs.spec.alpha/map-spec-impl","G__52444","cljs.core/map?","cljs.core/contains?","cljs.spec.alpha.every_impl","G__52445","cljs.core/coll?","G__52446","G__52447","app.csv-data-processing/DatedRows","app.time/Date","app.csv-data-processing/ProcessedRows","app.time/Timestamp","app.csv-data-processing/get-rows-by-dates","rows","cljs.core.into","cljs.core/sorted-map","cljs.core.map","row","cljs.spec.alpha/fspec-impl","cljs.spec.alpha.spec_impl","cljs.spec.alpha/cat-impl","G__52449","var_args","args__4870__auto__","len__4864__auto__","i__4865__auto__","argseq__4871__auto__","cljs.core/IndexedSeq","app.csv-data-processing/merge-rows-using-dates","seq52450","self__4852__auto__","cljs.core/seq","sets-of-rows","cljs.core/vals","cljs.core.apply","cljs.core/merge-with","row1","row2","cljs.core.merge","p1__52452#","app.csv-data-processing/add-timestamps","data","cljs.core.assoc","app.time/map-to-timestamp","app.time/parse-date-range","p1__52456#","p__52458","vec__52459","cljs.core.nth","app.csv-data-processing/floatify-data","k","v","cljs.core._EQ_","js/parseFloat","app.csv-data-processing/get-all-data-validation-string","seq52464","headers","p1__52462#","cljs.core.remove","cljs.core/flatten","p1__52463#","cljs.core/keys","cljs.core/first","duplicate-headers","iter__4652__auto__","s__52467","cljs.core/LazySeq","temp__5753__auto__","cljs.core/chunked-seq?","c__4650__auto__","size__4651__auto__","cljs.core/count","b__52469","cljs.core/chunk-buffer","i__52468","vec__52471","cljs.core/-nth","cljs.core/chunk-append","cljs.core/chunk-cons","cljs.core/chunk","iter__52466","cljs.core/chunk-rest","vec__52474","cljs.core/cons","cljs.core/rest","id","freq","cljs.core/frequencies","clojure.string.join","app.csv-data-processing/get-validation-string","all-dates","unique-dates","cljs.core/set","G__52481","app.csv-data-processing/process-csv-data","seq52483","app.csv_data_processing.process_csv_data","cljs.core/chunk-first"],"sourcesContent":["(ns app.csv-data-processing\n  (:require\n    [app.time :as time]\n    [app.specs :as specs]\n    [cljs.spec.alpha :as s]\n    [malli.core :as m]\n    [ghostwheel.core :as g :refer [>defn >defn- >fdef => | <- ?]]\n    [clojure.set :refer [union]]\n    [clojure.string :as st]))\n\n(s/def ::dated-row (s/keys :req-un [:app.time/date]))\n(s/def ::dated-rows (s/coll-of ::dated-row))\n\n; Also all values are floats (not strings)\n(s/def ::processed-row (s/keys :req-un [:app.time/date\n                                        :app.time/timestamp]))\n(s/def ::processed-rows (s/coll-of ::processed-row))\n\n(def DatedRows\n  [:sequential [:map [:date time/Date]]])\n\n(def ProcessedRows\n  [:sequential [:map [:date time/Date]\n                     [:timestamp time/Timestamp]]])\n\n; Returns map of dates to :dated-row maps.\n;; TODO figure out how to express this in spec\n(defn get-rows-by-dates [rows]\n  ; TODO find out how to get spec to do this assert for me\n  ; (assert (:date (first rows)))\n  (into (sorted-map) (map (fn [row] [(:date row) row]) rows)))\n\n(>defn merge-rows-using-dates\n  \"Merges N sequences of row maps (e.g. from different spreadsheets) using\n  the :date field as the joining attribute.\"\n  [& sets-of-rows]\n  [(s/coll-of ::dated-rows)\n   => ::dated-rows]\n  (vals (apply merge-with (fn [row1 row2] (merge row1 row2))\n               (map get-rows-by-dates sets-of-rows))))\n\n\n(>defn add-timestamps\n  [data]\n  [::dated-rows => ::dated-rows]\n  (map #(assoc % :timestamp (time/map-to-timestamp\n                              (time/parse-date-range\n                                (:date %))))\n       data))\n\n(>defn floatify-data\n  [data]\n  [::dated-rows => ::dated-rows]\n  (map #(into {} (map (fn [[k v]]\n                        [k (if (= k :date)\n                             v\n                             (js/parseFloat v))])\n                      %))\n       data))\n\n(floatify-data [{:a \"100\" :b \"20\" :date \"4/2/00 to 5/2/00\"}])\n\n; TODO add spec validation to this function\n(defn get-all-data-validation-string\n  {:malli/schema [:=> [:cat [:sequential DatedRows]]\n                  specs/Hiccup]}\n  [& sets-of-rows]\n  (let [headers (remove #(= :date %)\n                        (flatten (map #(keys (first %)) sets-of-rows)))\n        duplicate-headers (for [[id freq] (frequencies headers)\n                                :when (> freq 1)]\n                            id)]\n    (if (seq duplicate-headers)  ; if not empty\n      [:div {:style {:color \"red\"}}\n       \"Some inputs headers were duplicated: \" (st/join \", \" duplicate-headers)]\n      [:div {:style {:color \"green\"}} \"Data validated successfully\"])))\n\n(defn get-validation-string\n  {:malli/schema [:=> [:cat DatedRows]\n                  specs/Hiccup]}\n  [rows]\n  (let [all-dates (map :date rows)\n        unique-dates (set all-dates)]\n    (if (not (= (count all-dates) (count unique-dates)))\n      [:div {:style {:color \"red\"}} \"Repeated dates found in input!\"]\n      [:div {:style {:color \"green\"}} \"Data validated successfully\"])))\n\n(>defn process-csv-data\n  [& sets-of-rows]\n  [(s/coll-of ::dated-rows)\n   => ::processed-rows]\n  (-> (apply merge-rows-using-dates sets-of-rows)\n    add-timestamps\n    floatify-data))\n\n(process-csv-data [{:a \"100\" :b \"20\" :date \"4/2/00 to 5/2/00\"}])\n"]}